# Адаптация миграций от Arrilot для Wordpress

Оригинальный пакет - [https://github.com/arrilot/bitrix-migrations](https://github.com/arrilot/bitrix-migrations)

## Установка

1) `composer require proklung/wp.migrations`

2) `cp vendor/proklung/wp-migrations/migrator bin/migrator` - копируем исполняемый файл в удобное место.

3) заходим внутрь и удостоверяемся что задается правильный $_SERVER['DOCUMENT_ROOT']. Меняем настройки если нужно.

4) `php migrator install`

Данная команда создаст в БД таблицу для хранения названий выполненных миграций.

По умолчанию:

1) Таблица называется wp_arrilot_migrations.

2) `composer.json` лежит в корне сайта, `migrator` в /bin.

3) Файлы миграций будут создаваться в директории `./app/arrilot_migrations` относительно корня сайта.

При необходимости всё это можно изменить в скопированном файле `migrator`.

## Использование

### Рабочий процесс

Рабочий процесс происходит через консоль и кратко описывается примерно так:

1) Создаем файл (или файлы) миграции при помощи `php migrator make название_миграции`

Файл миграции представляет из себя класс с двумя методами `up()` и `down()`

2) Реализуем в методе `up()`необходимые изменения в БД. При желании в методе `down()` реализуем откат этих измнений

3) Применяем имеющиеся миграции - `php migrator migrate`

4) Вносим файлы миграций в систему контроля версий, чтобы их можно было запустить и на других машинах


### Доступные команды

Список доступных команд можно получить в консоли - `php bin/migrator list`

<table>
<tr><th>Название</th><th>Описание</th></tr>
<tr>
    <td>`php/bin migrator install`</td>
    <td>Создает таблицу для хранения миграций. Запускается один раз.</td>
</tr>
<tr>
    <td>`php/bin migrator make название_миграции`</td>
    <td>
        Создает файл миграции
        Опции:<br>
        `-d foo/bar` - указать поддиректорию, в которой будет создана миграция<br>
    </td>
</tr>
<tr>
    <td>`php/bin migrator migrate`</td>
    <td>Применяет все доступные для применения миграции. Миграции примененные ранее не применяются.</td>
</tr>
<tr>
    <td>`php/bin migrator rollback`</td>
    <td>
        Откатывает последнюю миграцию (метод `down()`). После этого её можно применить повторно.<br>
        Опции:<br>
        `--hard` - выполнить жесткий откат без вызова метода `down()`<br>
        `--delete` - удалить файл с миграцией после отката.<br>
    </td>
</tr>
<tr>
    <td>`php/bin migrator templates`</td>
    <td>Показывает подробную таблицу со всем существующими шаблонами миграций</td>
</tr>
<tr>
    <td>`php/bin migrator status`</td>
    <td>Показывает доступные для выполнения миграции, а также последние выполненные.</td>
</tr>
<tr>
    <td>`php/bin migrator archive`</td>
    <td>
        Переносит все миграции в архив. По умолчанию это директория /app/archive_migrations, но можно переопределить в конфиге, указав "dir_archive"<br>
        Опции:<br>
        `-w 10` - не переносить в архив последние N миграций<br>
    </td>
</tr>
</table>

### Шаблоны миграций

Так как изменение структуры БД битрикса через его АПИ  - занятие крайне малоприятное, то для облегчения этого процесса есть механизм шаблонов миграций, работающий следущим образом:
При генерации файла миграции можно указать его шаблон: `php migrator make название_миграции -t add_iblock` где `add_block` - название шаблона.
При этом сгенерируется класс с бойлерплейтом из шаблона и остается лишь указать детали (например название и код инфоблока)
Свои шаблоны миграций можно добавить напрямую в файле `migrator` при помощи `TemplateCollection::registerTemplate()`

Имеющиеся шаблоны:

<table>
<tr><th>Название</th><th>Описание</th><th>Алиасы</th></tr>
<tr>
    <td>`default`</td>
    <td>Чистый шаблон по умолчанию</td>
    <td></td>
</tr>

<tr>
    <td>`query`</td>
    <td>Произвольный запрос в БД</td>
    <td></td>
</tr>
<tr>
    <td>`add_table`</td>
    <td>Создание таблицы через</td>
    <td>`create_table`</td>
</tr>
<tr>
    <td>`delete_table`</td>
    <td>Удаление таблицы</td>
    <td>`drop_table`</td>
</tr>
</table>

6) `php migrator status` - показывает доступные для выполнения миграции, а также последние выполненные.
